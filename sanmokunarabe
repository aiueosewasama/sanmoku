<?php
// PHP„Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØ„ÅÆÈñãÂßã

// --- 1. „Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆÈñãÂßã„Å®ÂàùÊúüÂåñ ---
session_start();

// ÂÆöÊï∞„ÅÆÂÆöÁæ©
const PLAYER_MARK = 'O'; // „Éó„É¨„Ç§„É§„Éº„ÅÆÊâã
const COMPUTER_MARK = 'X'; // „Ç≥„É≥„Éî„É•„Éº„Çø„ÅÆÊâã
const EMPTY_CELL = ''; // Á©∫„ÅÆ„Éû„Çπ

// „Éú„Éº„Éâ„ÅÆÂàùÊúüÁä∂ÊÖã (3x3„ÅÆÈÖçÂàó)
$initial_board = array_fill(0, 3, array_fill(0, 3, EMPTY_CELL));

// „Çª„ÉÉ„Ç∑„Éß„É≥„Å´„Éú„Éº„ÉâÊÉÖÂ†±„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÂàùÊúüÂåñ
if (!isset($_SESSION['board'])) {
    $_SESSION['board'] = $initial_board;
    $_SESSION['status'] = 'playing'; // playing, win_player, win_computer, draw
    $_SESSION['turn'] = PLAYER_MARK; // „Éó„É¨„Ç§„É§„Éº„Åã„ÇâÈñãÂßã
}

$board = &$_SESSION['board'];
$status = &$_SESSION['status'];
$turn = &$_SESSION['turn'];
$message = ''; // „É¶„Éº„Ç∂„Éº„Å∏„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏

// --- 2. ÂãùÊïóÂà§ÂÆö„É≠„Ç∏„ÉÉ„ÇØ ---

/**
 * ÁèæÂú®„ÅÆ„Éú„Éº„Éâ„ÅÆÁä∂ÊÖã„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„ÄÅÂãùËÄÖ„Åæ„Åü„ÅØÂºï„ÅçÂàÜ„Åë„ÇíÂà§ÂÆö„Åô„Çã
 * @param array $board 3x3„ÅÆ„Éú„Éº„ÉâÈÖçÂàó
 * @return string 'playing', 'win_player', 'win_computer', 'draw' „ÅÆ„ÅÑ„Åö„Çå„Åã
 */
function check_status($board) {
    // ÂãùÂà©Êù°‰ª∂„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ (Ë°å„ÄÅÂàó„ÄÅÂØæËßíÁ∑ö)
    $lines = [];
    
    // Ë°å
    for ($i = 0; $i < 3; $i++) { $lines[] = $board[$i]; }
    // Âàó
    for ($j = 0; $j < 3; $j++) { $lines[] = [$board[0][$j], $board[1][$j], $board[2][$j]]; }
    // ÂØæËßíÁ∑ö
    $lines[] = [$board[0][0], $board[1][1], $board[2][2]]; // Â∑¶‰∏ä„Åã„ÇâÂè≥‰∏ã
    $lines[] = [$board[0][2], $board[1][1], $board[2][0]]; // Âè≥‰∏ä„Åã„ÇâÂ∑¶‰∏ã

    foreach ($lines as $line) {
        if ($line[0] !== EMPTY_CELL && $line[0] === $line[1] && $line[1] === $line[2]) {
            return ($line[0] === PLAYER_MARK) ? 'win_player' : 'win_computer';
        }
    }

    // Âºï„ÅçÂàÜ„ÅëÂà§ÂÆö (Á©∫„ÅÆ„Éû„Çπ„ÅåÊÆã„Å£„Å¶„ÅÑ„Çã„Åã)
    $is_full = true;
    foreach ($board as $row) {
        if (in_array(EMPTY_CELL, $row)) {
            $is_full = false;
            break;
        }
    }

    if ($is_full) {
        return 'draw';
    }

    return 'playing';
}

// --- 3. „Ç≥„É≥„Éî„É•„Éº„Çø„ÅÆÊÄùËÄÉ„É≠„Ç∏„ÉÉ„ÇØ (Á∞°ÊòìÁöÑ„Å™„É©„É≥„ÉÄ„É†ÈÅ∏Êäû) ---

/**
 * „Ç≥„É≥„Éî„É•„Éº„Çø„ÅÆÊâã„ÇíÊ±∫ÂÆö„Åô„Çã (Á©∫„ÅÑ„Å¶„ÅÑ„Çã„Éû„Çπ„Åã„Çâ„É©„É≥„ÉÄ„É†„Å´ÈÅ∏Êäû)
 * @param array $board 3x3„ÅÆ„Éú„Éº„ÉâÈÖçÂàó
 * @return array|null [row, col] „ÅÆÈÖçÂàó„ÄÅ„Åæ„Åü„ÅØnullÔºàÊâì„Å§Â†¥ÊâÄ„Åå„Å™„ÅÑÂ†¥ÂêàÔºâ
 */
function get_computer_move($board) {
    $empty_cells = [];
    for ($r = 0; $r < 3; $r++) {
        for ($c = 0; $c < 3; $c++) {
            if ($board[$r][$c] === EMPTY_CELL) {
                $empty_cells[] = [$r, $c];
            }
        }
    }

    if (!empty($empty_cells)) {
        $randomIndex = array_rand($empty_cells);
        return $empty_cells[$randomIndex];
    }
    return null;
}


// --- 4. „Éï„Ç©„Éº„É†Âá¶ÁêÜ („É¶„Éº„Ç∂„Éº„ÅÆÊâã„ÅÆÂèó„Åë‰ªò„Åë) ---
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    
    // „É™„Çª„ÉÉ„Éà„Éú„Çø„É≥„ÅåÊäº„Åï„Çå„ÅüÂ†¥Âêà
    if (isset($_POST['reset'])) {
        $_SESSION['board'] = $initial_board;
        $_SESSION['status'] = 'playing';
        $_SESSION['turn'] = PLAYER_MARK;
        $message = '„Ç≤„Éº„É†„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü„ÄÇ„ÅÇ„Å™„Åü„ÅÆÊâãÁï™„Åß„Åô„ÄÇ';
        // „É™„ÉÄ„Ç§„É¨„ÇØ„Éà„Åó„Å¶POST„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢
        header('Location: sanmoku.php');
        exit;
    }

    // „Éó„É¨„Ç§„É§„Éº„ÅÆÊâãÁï™„Åß„ÅÇ„Çä„ÄÅ„Åã„Å§„Ç≤„Éº„É†„ÅåÈÄ≤Ë°å‰∏≠„ÅÆÂ†¥Âêà
    if ($status === 'playing' && $turn === PLAYER_MARK && isset($_POST['row']) && isset($_POST['col'])) {
        
        $r = (int)$_POST['row'];
        $c = (int)$_POST['col'];

        // ÊúâÂäπ„Å™„Éû„Çπ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        if ($r >= 0 && $r < 3 && $c >= 0 && $c < 3 && $board[$r][$c] === EMPTY_CELL) {
            
            // „Éó„É¨„Ç§„É§„Éº„ÅÆÊâã„ÇíÈÖçÁΩÆ
            $board[$r][$c] = PLAYER_MARK;
            
            // Áä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØ
            $status = check_status($board);

            if ($status === 'playing') {
                $turn = COMPUTER_MARK;
                $message = '„Ç≥„É≥„Éî„É•„Éº„Çø„ÅÆÊâãÁï™„Åß„Åô...';
            }
        
        } else {
            $message = 'ÁÑ°Âäπ„Å™„Éû„Çπ„Åß„Åô„ÄÇÁ©∫„ÅÑ„Å¶„ÅÑ„Çã„Éû„Çπ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ';
        }
    }

    // --- 5. „Ç≥„É≥„Éî„É•„Éº„Çø„ÅÆ„Çø„Éº„É≥„ÅÆÂÆüË°å ---
    // „Éó„É¨„Ç§„É§„Éº„ÅåÊâã„ÇíÊâì„Å°„ÄÅ„Åæ„Å†„Ç≤„Éº„É†„ÅåÁ∂öË°å‰∏≠„Åß„ÄÅ„Åã„Å§„Ç≥„É≥„Éî„É•„Éº„Çø„ÅÆÊâãÁï™„ÅÆÂ†¥Âêà
    if ($status === 'playing' && $turn === COMPUTER_MARK) {
        
        $comp_move = get_computer_move($board);
        
        if ($comp_move !== null) {
            list($r, $c) = $comp_move;
            $board[$r][$c] = COMPUTER_MARK;
            
            // Áä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØ
            $status = check_status($board);
            
            if ($status === 'playing') {
                $turn = PLAYER_MARK;
                $message = '„ÅÇ„Å™„Åü„ÅÆÊâãÁï™„Åß„Åô (O)„ÄÇ';
            }
        }
    }

    // „Ç≤„Éº„É†ÁµÇ‰∫ÜÂæå„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏Ë®≠ÂÆö
    if ($status !== 'playing') {
        if ($status === 'win_player') {
            $message = 'üéâ **„ÅÇ„Å™„Åü„ÅÆÂãù„Å°„Åß„ÅôÔºÅ** „Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ';
        } elseif ($status === 'win_computer') {
            $message = 'üò¢ **„Ç≥„É≥„Éî„É•„Éº„Çø„ÅÆÂãù„Å°„Åß„Åô...** ÊÆãÂøµÔºÅ';
        } else {
            $message = 'ü§ù **Âºï„ÅçÂàÜ„ÅëÔºà„ÅÇ„ÅÑ„ÅìÔºâ** „Åß„ÅôÔºÅ';
        }
    }
    
    // „Ç≥„É≥„Éî„É•„Éº„Çø„ÅåÊâã„ÇíÊâì„Å£„Åü„Çâ„ÄÅ„Éñ„É©„Ç¶„Ç∂„Çí„É™„É≠„Éº„Éâ„Åó„Å¶ÊúÄÊñ∞„ÅÆ„Éú„Éº„Éâ„ÇíË°®Á§∫ÔºàÈÄ£Á∂öPOST„ÇíÈò≤„Åê„Åü„ÇÅÔºâ
    if ($status === 'playing' && $turn === PLAYER_MARK && isset($_POST['row'])) {
        header('Location: sanmoku.php');
        exit;
    }
} else {
    // ÊúÄÂàù„ÅÆ„Ç¢„ÇØ„Çª„ÇπÊôÇ„Åæ„Åü„ÅØ„É™„Çª„ÉÉ„ÉàÂæå„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏
    if ($status === 'playing') {
        $message = '„ÅÇ„Å™„Åü„ÅÆÊâãÁï™„Åß„Åô (O)„ÄÇ„Éû„Çπ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
    }
}

// --- 6. HTML„ÅÆË°®Á§∫ ---
?>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>PHP‰∏âÁõÆ‰∏¶„Åπ„Ç≤„Éº„É†</title>
    <style>
        body { font-family: 'Arial', sans-serif; text-align: center; margin-top: 50px; background-color: #f0f0f0; }
        .container { width: fit-content; margin: 0 auto; padding: 20px; border-radius: 10px; background-color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        .board { display: grid; grid-template-columns: repeat(3, 100px); grid-template-rows: repeat(3, 100px); margin: 20px auto; border: 3px solid #333; }
        .cell {
            width: 100%; height: 100%;
            border: 1px solid #aaa;
            display: flex; justify-content: center; align-items: center;
            font-size: 48px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .cell:hover { background-color: #eee; }
        .cell-played { cursor: default !important; }
        .cell-O { color: #007bff; }
        .cell-X { color: #dc3545; }
        .message { padding: 10px; margin-bottom: 20px; border-radius: 5px; font-size: 1.2em; }
        .message-win { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message-lose { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message-draw { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .message-normal { background-color: #e9ecef; color: #495057; border: 1px solid #ced4da; }
        
        /* „Ç≤„Éº„É†ÁµÇ‰∫ÜÊôÇ„ÅÆ„Çª„É´„ÅÆ„Éõ„Éê„ÉºÂäπÊûú„ÇíÁÑ°ÂäπÂåñ */
        <?php if ($status !== 'playing'): ?>
        .cell { pointer-events: none; }
        <?php endif; ?>
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ùå‚≠ï ‰∏âÁõÆ‰∏¶„Åπ (Tic-Tac-Toe) </h1>
        
        <?php
            $msg_class = 'message-normal';
            if ($status === 'win_player') $msg_class = 'message-win';
            elseif ($status === 'win_computer') $msg_class = 'message-lose';
            elseif ($status === 'draw') $msg_class = 'message-draw';
        ?>
        <div class="message <?= $msg_class ?>">
            <?= $message ?>
        </div>

        <div class="board">
            <?php for ($r = 0; $r < 3; $r++): ?>
                <?php for ($c = 0; $c < 3; $c++): ?>
                    
                    <?php if ($board[$r][$c] === EMPTY_CELL && $status === 'playing' && $turn === PLAYER_MARK): ?>
                        <form method="POST" style="height: 100%; margin: 0;">
                            <input type="hidden" name="row" value="<?= $r ?>">
                            <input type="hidden" name="col" value="<?= $c ?>">
                            <button type="submit" class="cell" title="„Åì„ÅÆ„Éû„Çπ„ÇíÈÅ∏„Å∂">
                                </button>
                        </form>
                    <?php else: ?>
                        <div class="cell cell-played cell-<?= $board[$r][$c] ?>">
                            <?= htmlspecialchars($board[$r][$c]) ?>
                        </div>
                    <?php endif; ?>

                <?php endfor; ?>
            <?php endfor; ?>
        </div>

        <form method="POST" style="margin-top: 20px;">
            <button type="submit" name="reset" style="padding: 10px 20px; font-size: 16px; cursor: pointer;">
                ÊúÄÂàù„Åã„Çâ„ÇÑ„ÇäÁõ¥„Åô
            </button>
        </form>
        
        <p style="margin-top: 30px; font-size: 0.9em;">
            „Éó„É¨„Ç§„É§„Éº: **<?= PLAYER_MARK ?>** (Èùí) | „Ç≥„É≥„Éî„É•„Éº„Çø: **<?= COMPUTER_MARK ?>** (Ëµ§)
        </p>
    </div>
</body>
</html>
